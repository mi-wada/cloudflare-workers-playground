<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>is-ojisan - ãŠã˜ã•ã‚“æ§‹æ–‡åˆ¤å®š</title>
  </head>
  <body>
    <header>
      <h1 id="heading">is-ojisan ğŸ§‘â€ğŸ¦³</h1>
    </header>
    <main>
      <label for="input" style="font-weight: bold">åˆ¤å®šã—ãŸã„æ–‡ç« </label>
      <textarea
        id="input"
        placeholder="åˆ¤å®šã—ãŸã„æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
        rows="3"
        style="width: 100%; resize: vertical"
        aria-label="åˆ¤å®šã—ãŸã„æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
      ></textarea>
      <button id="btn" aria-label="ãŠã˜ã•ã‚“æ§‹æ–‡åˆ¤å®š">ãŠã˜ã•ã‚“æ§‹æ–‡åˆ¤å®š</button>
      <div
        id="result"
        style="white-space: pre-wrap; word-break: break-all; margin-top: 1em"
        aria-live="polite"
      ></div>
    </main>
    <script type="module">
      function getQueryParam(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
      }

      const input = document.getElementById("input");
      const btn = document.getElementById("btn");
      const result = document.getElementById("result");

      function renderResult(data) {
        if (data.error) {
          result.textContent = data.error;
          return;
        }
        let html = "";
        if (typeof data.ojisanScore === "number") {
          html += `ãŠã˜ã•ã‚“æ§‹æ–‡åº¦: <b>${data.ojisanScore}</b>/100<br>`;
        }
        if (data.reasons) {
          html += `ç†ç”±: ${data.reasons}<br>`;
        }
        if (data.suggestion) {
          html += `<br>ãŠã˜ã•ã‚“æ§‹æ–‡ã‚’é¿ã‘ã‚‹ã«ã¯: ${data.suggestion}`;
        }
        result.innerHTML = html;
      }

      function setLoading(isLoading) {
        btn.disabled = isLoading;
        btn.textContent = isLoading ? "åˆ¤å®šä¸­..." : "ãŠã˜ã•ã‚“æ§‹æ–‡åˆ¤å®š";
      }

      async function checkOjisan(q) {
        // å…¥åŠ›æ¬„ã®å†…å®¹ã§URLã®qãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ›´æ–°
        const url = new URL(window.location);
        url.searchParams.set("q", q);
        window.history.replaceState(null, "", url);
        setLoading(true);
        result.textContent = "åˆ¤å®šä¸­...";
        try {
          const res = await fetch(`/api?q=${encodeURIComponent(q)}`);
          if (res.status === 429) {
            const data = await res.json();
            const reset = res.headers.get("X-RateLimit-Reset");
            let resetMsg = "";
            if (reset) {
              const resetDate = new Date(Number(reset) * 1000);
              resetMsg = `\nãƒªã‚»ãƒƒãƒˆæ™‚åˆ»: ${resetDate.toLocaleString()}`;
            }
            result.textContent =
              (data.message || "Rate limit exceeded.") + resetMsg;
            setLoading(false);
            return;
          }
          const data = await res.json();
          renderResult(data);
        } catch (e) {
          result.textContent =
            "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
        } finally {
          setLoading(false);
        }
      }

      // åˆæœŸè¡¨ç¤ºã§qãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Œã°å…¥åŠ›æ¬„ã«åæ˜ ã—ã€å³åˆ¤å®š
      const initialQ = getQueryParam("q");
      if (initialQ) {
        input.value = initialQ;
        checkOjisan(initialQ);
      }

      btn.onclick = function () {
        if (!input.value.trim()) {
          result.textContent = "æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
          return;
        }
        checkOjisan(input.value);
      };

      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
          btn.click();
        }
      });
    </script>
  </body>
</html>
